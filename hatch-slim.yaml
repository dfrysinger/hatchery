#cloud-config
# version: main (slim) -- bootstrap.sh fetches large scripts from GitHub
package_update: false
package_upgrade: false
bootcmd:
  - [bash, -lc, "mkdir -p /var/lib/init-status;[ -f /var/lib/init-status/setup-complete ]&&exit 0;echo 0>/var/lib/init-status/stage;echo 1>/var/lib/init-status/phase;echo \"$(date -u +%Y-%m-%dT%H:%M:%SZ) STAGE=0 PHASE=1 DESC=init\">>/var/log/init-stages.log;systemctl stop apt-daily.timer apt-daily-upgrade.timer apt-daily.service apt-daily-upgrade.service unattended-upgrades 2>/dev/null||true;systemctl disable apt-daily.timer apt-daily-upgrade.timer 2>/dev/null||true;killall -9 unattended-upgr apt apt-get dpkg 2>/dev/null||true"]
  - [bash, -lc, "[ -f /var/lib/init-status/phase2-complete ]&&exit 0;systemctl stop xrdp xrdp-sesman 2>/dev/null||true;systemctl mask xrdp xrdp-sesman 2>/dev/null||true"]
  - [bash, -lc, "[ -f /var/lib/init-status/setup-complete ]&&exit 0;mkdir -p /tmp/downloads;curl -sL https://nodejs.org/dist/v22.12.0/node-v22.12.0-linux-x64.tar.xz -o /tmp/downloads/node.tar.xz& echo $!>/tmp/downloads/node.pid;wget -q -O /tmp/downloads/chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb& echo $!>/tmp/downloads/chrome.pid"]
  - [bash, -lc, "[ -f /var/lib/init-status/setup-complete ]&&[ ! -f /var/lib/init-status/boot-complete ]&&{ echo 11>/var/lib/init-status/stage;echo \"$(date -u +%Y-%m-%dT%H:%M:%SZ) STAGE=11 DESC=ready\">>/var/log/init-stages.log;touch /var/lib/init-status/boot-complete;}||true"]
write_files:
  - path: /etc/hatchery-version
    content: "main"
  - path: /etc/droplet.env
    owner: root:root
    permissions: "0600"
    content: |
      USERNAME="bot"
      SSH_KEY_B64=""
      DO_TOKEN_B64="[[DO_TOKEN_B64]]"
      PASSWORD_B64="[[PASSWORD_B64]]"
      # PLATFORM, DISCORD_*, TELEGRAM_OWNER_ID are extracted from HABITAT_B64
      # by parse-habitat.py -> /etc/habitat-parsed.env (no Shortcut placeholders needed)
      TELEGRAM_USER_ID_B64="[[TELEGRAM_USER_ID_B64]]"
      ANTHROPIC_KEY_B64="[[ANTHROPIC_KEY_B64]]"
      BRAVE_KEY_B64="[[BRAVE_KEY_B64]]"
      GOOGLE_API_KEY_B64="[[GOOGLE_API_KEY_B64]]"
      DROPBOX_TOKEN_B64="[[DROPBOX_TOKEN_B64]]"
      EMAIL_B64="[[EMAIL_B64]]"
      IMAP_HOST_B64="[[IMAP_HOST_B64]]"
      SMTP_HOST_B64="[[SMTP_HOST_B64]]"
      EMAIL_PASSWORD_B64="[[EMAIL_PASSWORD_B64]]"
      CALDAV_URL_B64="[[CALDAV_URL_B64]]"
      CALDAV_USER_B64="[[CALDAV_USER_B64]]"
      CALDAV_PASSWORD_B64="[[CALDAV_PASSWORD_B64]]"
      GH_TOKEN_B64="[[GH_TOKEN_B64]]"
      GMAIL_CLIENT_ID_B64="[[GMAIL_CLIENT_ID_B64]]"
      GMAIL_CLIENT_SECRET_B64="[[GMAIL_CLIENT_SECRET_B64]]"
      GMAIL_REFRESH_TOKEN_B64="[[GMAIL_REFRESH_TOKEN_B64]]"
      OPENAI_ACCESS_B64="[[OPENAI_ACCESS_B64]]"
      OPENAI_REFRESH_B64="[[OPENAI_REFRESH_B64]]"
      OPENAI_EXPIRES_B64="[[OPENAI_EXPIRES_B64]]"
      OPENAI_ACCOUNT_ID_B64="[[OPENAI_ACCOUNT_ID_B64]]"
      HABITAT_B64="[[HABITAT_B64]]"
      AGENT_LIB_B64="[[AGENT_LIB_B64]]"
  - path: /etc/needrestart/conf.d/99-autorestart.conf
    permissions: "0644"
    content: |
      $nrconf{restart} = 'a';
      $nrconf{blacklist_rc} = [qr/^cloud-init/, qr/^cloud-final/, qr/^cloud-config/];
  - path: /etc/ssh/sshd_config.d/99-password-auth.conf
    permissions: "0644"
    content: |
      PasswordAuthentication yes
      PermitRootLogin prohibit-password
  - path: /usr/local/bin/set-stage.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      echo "$1">/var/lib/init-status/stage
      echo "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ) STAGE=$1 PHASE=$(cat /var/lib/init-status/phase 2>/dev/null||echo 1) DESC=$2">>/var/log/init-stages.log
  - path: /usr/local/bin/set-phase.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      echo "$1">/var/lib/init-status/phase
      echo "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ) PHASE=$1 DESC=$2">>/var/log/init-stages.log
  - path: /usr/local/bin/parse-habitat.py
    permissions: "0755"
    content: |
      #!/usr/bin/env python3
      import json,base64,os,sys
      d=lambda v:base64.b64decode(v).decode() if v else ""
      b=lambda s:base64.b64encode((s or"").encode()).decode()
      hr=os.environ.get('HABITAT_B64','')
      lr=os.environ.get('AGENT_LIB_B64','')
      if not hr:print("ERROR: HABITAT_B64 not set",file=sys.stderr);sys.exit(1)
      try:h=json.loads(d(hr))
      except Exception as e:print(f"ERROR: {e}",file=sys.stderr);sys.exit(1)
      lib={}
      if lr:
          try:lib=json.loads(d(lr))
          except:pass
      with open('/etc/habitat.json','w') as f:json.dump(h,f,indent=2)
      os.chmod('/etc/habitat.json',0o600)
      p=h.get("platform","telegram");ag=h.get("agents",[])
      dc=h.get("discord",{});tg=h.get("telegram",{});co=h.get("council",{})
      ct=co.get("telegram",{})
      cgi=ct.get("groupId",co.get("groupId",h.get("councilGroupId","")))
      toi=tg.get("ownerId","")
      w=[]
      for k,v in [("HABITAT_NAME",h["name"]),("HABITAT_NAME_B64",b(h["name"])),
          ("DESTRUCT_MINS",h.get("destructMinutes",0)),("DESTRUCT_MINS_B64",b(str(h.get("destructMinutes",0)))),
          ("BG_COLOR",h.get("bgColor","2D3748")),("PLATFORM",p),("PLATFORM_B64",b(p)),
          ("DISCORD_GUILD_ID",dc.get("serverId","")),("DISCORD_GUILD_ID_B64",b(dc.get("serverId",""))),
          ("DISCORD_OWNER_ID",dc.get("ownerId","")),("DISCORD_OWNER_ID_B64",b(dc.get("ownerId",""))),
          ("TELEGRAM_OWNER_ID",toi),("TELEGRAM_OWNER_ID_B64",b(toi)),("TELEGRAM_USER_ID_B64",b(toi)),
          ("COUNCIL_GROUP_ID",cgi),("COUNCIL_GROUP_NAME",co.get("groupName","")),
          ("COUNCIL_JUDGE",co.get("judge","")),("HABITAT_DOMAIN",h.get("domain","")),
          ("GLOBAL_IDENTITY_B64",b(h.get("globalIdentity",""))),("GLOBAL_BOOT_B64",b(h.get("globalBoot",""))),
          ("GLOBAL_BOOTSTRAP_B64",b(h.get("globalBootstrap",""))),("GLOBAL_SOUL_B64",b(h.get("globalSoul",""))),
          ("GLOBAL_AGENTS_B64",b(h.get("globalAgents",""))),("GLOBAL_USER_B64",b(h.get("globalUser",""))),
          ("AGENT_COUNT",len(ag))]:
          w.append(f'{k}="{v}"')
      for i,ar in enumerate(ag):
          n=i+1;nm=ar["agent"];le=lib.get(nm,{})
          mo=ar.get("model")or le.get("model","anthropic/claude-opus-4-5")
          tt=ar.get("telegramBotToken",ar.get("botToken",""));dt=ar.get("discordBotToken","")
          for k,v in [("NAME",nm),("NAME_B64",b(nm)),("BOT_TOKEN",tt),("BOT_TOKEN_B64",b(tt)),
              ("TELEGRAM_BOT_TOKEN",tt),("TELEGRAM_BOT_TOKEN_B64",b(tt)),
              ("DISCORD_BOT_TOKEN",dt),("DISCORD_BOT_TOKEN_B64",b(dt)),("MODEL",mo),
              ("IDENTITY_B64",b(le.get("identity",""))),("SOUL_B64",b(le.get("soul",""))),
              ("AGENTS_B64",b(le.get("agents",""))),("BOOT_B64",b(le.get("boot",""))),
              ("BOOTSTRAP_B64",b(le.get("bootstrap",""))),("USER_B64",b(le.get("user","")))]:
              w.append(f'AGENT{n}_{k}="{v}"')
      with open('/etc/habitat-parsed.env','w') as f:f.write('\n'.join(w)+'\n')
      os.chmod('/etc/habitat-parsed.env',0o600)
      print(f"Parsed habitat '{h['name']}' with {len(ag)} agents (platform: {p})")
  - path: /usr/local/bin/tg-notify.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -a;source /etc/droplet.env;set +a
      d(){ [ -n "$1" ]&&echo "$1"|base64 -d 2>/dev/null||echo "";}
      [ ! -f /etc/habitat-parsed.env ]&&python3 /usr/local/bin/parse-habitat.py 2>/dev/null
      [ -f /etc/habitat-parsed.env ]&&source /etc/habitat-parsed.env
      P="${PLATFORM:-$(d "$PLATFORM_B64")}";P="${P:-telegram}";MSG="$1";[ -z "$MSG" ]&&exit 1
      stg(){ local T="${AGENT1_BOT_TOKEN}" U=$(d "$TELEGRAM_USER_ID_B64");[ -z "$T" ]||[ -z "$U" ]&&return 1
        curl -sf --max-time 10 "https://api.telegram.org/bot${T}/sendMessage" -d "chat_id=${U}" -d "text=${MSG}">/dev/null 2>&1;}
      sdc(){ local B="${AGENT1_DISCORD_BOT_TOKEN}" O="${DISCORD_OWNER_ID:-$(d "$DISCORD_OWNER_ID_B64")}";[ -z "$B" ]||[ -z "$O" ]&&return 1
        local R=$(curl -sf --max-time 10 -XPOST "https://discord.com/api/v10/users/@me/channels" -H "Authorization: Bot ${B}" -H "Content-Type: application/json" -d "{\"recipient_id\":\"${O}\"}" 2>/dev/null)
        [ -z "$R" ]&&return 1;local C=$(echo "$R"|python3 -c "import sys,json;print(json.load(sys.stdin).get('id',''))" 2>/dev/null);[ -z "$C" ]&&return 1
        curl -sf --max-time 10 -XPOST "https://discord.com/api/v10/channels/${C}/messages" -H "Authorization: Bot ${B}" -H "Content-Type: application/json" \
          -d "{\"content\":$(echo "$MSG"|python3 -c 'import sys,json;print(json.dumps(sys.stdin.read().strip()))')}">/dev/null 2>&1;}
      case "$P" in telegram)stg||exit 1;;discord)sdc||exit 1;;both)stg;T=$?;sdc;D=$?;[ $T -ne 0 ]&&[ $D -ne 0 ]&&exit 1;;*)stg;exit $?;;esac
  - path: /usr/local/bin/set-council-group.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -a;source /etc/droplet.env;set +a
      d(){ [ -n "$1" ]&&echo "$1"|base64 -d 2>/dev/null||echo "";}
      P="${PLATFORM:-$(d "$PLATFORM_B64")}";[ "${P:-telegram}" = "discord" ]&&exit 0
      exec /usr/local/bin/set-council-group.telegram.sh "$@"
  - path: /usr/local/bin/api-server.py
    permissions: "0755"
    content: |
      #!/usr/bin/env python3
      import http.server,socketserver,subprocess,json,os
      PORT=8080
      S1={0:"init",1:"preparing",2:"installing-bot",3:"bot-online"}
      S2={4:"desktop-environment",5:"developer-tools",6:"browser-tools",7:"desktop-services",8:"skills-apps",9:"remote-access",10:"finalizing",11:"ready"}
      def ck(n):
        try:return subprocess.run(["systemctl","is-active",n],capture_output=True,timeout=5).stdout.decode().strip()=="active"
        except:return False
      def st():
        s=p=0
        try:s=int(open('/var/lib/init-status/stage').read().strip());p=int(open('/var/lib/init-status/phase').read().strip())
        except:p=1
        ep=lambda f:os.path.exists(f'/var/lib/init-status/{f}')
        p1=ep('phase1-complete');p2=ep('phase2-complete');sd=ep('setup-complete');bo=ck('clawdbot');sm=ep('safe-mode')
        sv={s:ck(s) for s in ['clawdbot','xrdp','desktop','x11vnc']} if p2 or sd else None
        return {"phase":p,"stage":s,"desc":S1.get(s) if p<=1 else S2.get(s,f"stage-{s}"),"bot_online":bo,"phase1_complete":p1,"phase2_complete":p2,"ready":sd and bo,"safe_mode":sm,"services":sv}
      class H(http.server.BaseHTTPRequestHandler):
        def log_message(self,*a):pass
        def do_GET(self):
          if self.path=='/status':self._j(200,st())
          elif self.path=='/health':s=st();self._j(200 if s['bot_online'] else 503,{"healthy":s['bot_online'],"phase":s['phase'],"desc":s['desc'],"safe_mode":s['safe_mode']})
          elif self.path=='/stages':self.send_response(200);self.send_header('Content-type','text/plain');self.end_headers();self.wfile.write(open('/var/log/init-stages.log').read().encode() if os.path.exists('/var/log/init-stages.log') else b"No log")
          else:self.send_response(404);self.end_headers()
        def do_POST(self):
          if self.path=='/sync':
            try:r=subprocess.run("/usr/local/bin/sync-clawdbot-state.sh",shell=True,capture_output=True,timeout=60);self._j(200,{"ok":r.returncode==0})
            except Exception as x:self._j(200,{"ok":False,"error":str(x)})
          elif self.path=='/prepare-shutdown':
            try:subprocess.run("/usr/local/bin/sync-clawdbot-state.sh",shell=True,timeout=60);subprocess.run("systemctl stop clawdbot",shell=True,timeout=30);self._j(200,{"ok":True,"ready_for_shutdown":True})
            except Exception as x:self._j(200,{"ok":False,"error":str(x)})
          else:self.send_response(404);self.end_headers()
        def _j(self,c,d):self.send_response(c);self.send_header('Content-type','application/json');self.end_headers();self.wfile.write(json.dumps(d).encode())
      class R(socketserver.TCPServer):allow_reuse_address=True
      with R(("",PORT),H) as h:h.serve_forever()
  - path: /etc/systemd/system/api-server.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Droplet Status API
      After=network.target
      [Service]
      ExecStart=/usr/local/bin/api-server.py
      Restart=always
      RestartSec=3
      User=root
      [Install]
      WantedBy=multi-user.target
  - path: /etc/systemd/system/post-boot-check.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Post-boot health check
      After=clawdbot.service network-online.target
      Wants=network-online.target
      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/post-boot-check.sh
      RemainAfterExit=yes
      [Install]
      WantedBy=multi-user.target
  - path: /etc/systemd/system/clawdbot-sync.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Sync Clawdbot memory to Dropbox
      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/sync-clawdbot-state.sh
      User=root
  - path: /etc/systemd/system/clawdbot-sync.timer
    permissions: "0644"
    content: |
      [Unit]
      Description=Periodic Clawdbot memory sync
      [Timer]
      OnBootSec=2min
      OnUnitActiveSec=2min
      [Install]
      WantedBy=timers.target
  - path: /usr/local/bin/bootstrap.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      set -a;source /etc/droplet.env;source /etc/habitat-parsed.env 2>/dev/null||true;set +a
      REPO="dfrysinger/hatchery";DIR="/opt/hatchery"
      VER=$(cat /etc/hatchery-version 2>/dev/null||echo "main")
      log(){ echo "[bootstrap] $*";}
      notify(){ [ -x /usr/local/bin/tg-notify.sh ]&&/usr/local/bin/tg-notify.sh "$1" 2>/dev/null||true;}
      fetch(){ local u="$1" d="$2" i;for i in 1 2 3;do curl -fSL --max-time 60 -o "$d" "$u"&&return 0;sleep $((i*5));done;notify "bootstrap: fetch failed -- $u";return 1;}
      mkdir -p "$DIR";T=$(mktemp)
      if [ "$VER" = "main" ];then
        log "Fetching main";fetch "https://github.com/${REPO}/archive/refs/heads/main.tar.gz" "$T"
        tar -xzf "$T" --strip-components=1 -C "$DIR"
      else
        log "Fetching v${VER}";S=$(mktemp);BU="https://github.com/${REPO}/releases/download/v${VER}"
        fetch "${BU}/hatchery-${VER}.tar.gz" "$T"
        if fetch "${BU}/sha256sums.txt" "$S" 2>/dev/null;then
          E=$(grep "hatchery-${VER}.tar.gz" "$S"|awk '{print $1}');A=$(sha256sum "$T"|awk '{print $1}')
          [ "$E" != "$A" ]&&{ notify "bootstrap: SHA256 mismatch";exit 1;}
        fi
        tar -xzf "$T" -C "$DIR";rm -f "$S"
      fi
      rm -f "$T";chmod +x "$DIR"/scripts/*.sh 2>/dev/null||true
      for f in "$DIR"/scripts/*.sh;do bn=$(basename "$f")
        case "$bn" in phase1-critical.sh|phase2-background.sh|build-full-config.sh)cp "$f" /usr/local/sbin/;;*)cp "$f" /usr/local/bin/;;esac;done
      for f in "$DIR"/scripts/*.py;do [ -f "$f" ]&&cp "$f" /usr/local/bin/&&chmod 755 "/usr/local/bin/$(basename "$f")";done
      [ -f "$DIR/gmail-api.py" ]&&cp "$DIR/gmail-api.py" /usr/local/bin/gmail-api.py&&chmod 755 /usr/local/bin/gmail-api.py
      [ -f "$DIR/set-council-group.sh" ]&&cp "$DIR/set-council-group.sh" /usr/local/bin/set-council-group.telegram.sh&&chmod 755 /usr/local/bin/set-council-group.telegram.sh
      chmod +x /usr/local/sbin/*.sh /usr/local/bin/*.sh 2>/dev/null||true
      notify "bootstrap: hatchery ${VER} installed -- starting phase1"
      /usr/local/sbin/phase1-critical.sh
users:
  - default
runcmd:
  - [bash, -lc, "systemctl daemon-reload;systemctl enable --now api-server;ufw allow 8080/tcp"]
  - [bash, -lc, "systemctl enable post-boot-check.service"]
  - [bash, -lc, "set -a;source /etc/droplet.env;set +a;python3 /usr/local/bin/parse-habitat.py"]
  - [bash, -lc, "/usr/local/bin/bootstrap.sh>>/var/log/bootstrap.log 2>&1"]
  - [bash, -lc, "/usr/local/bin/schedule-destruct.sh"]
  - [bash, -lc, "/usr/local/bin/rename-bots.sh"]
